{% extends "base.html" %}
{% block title %}Document List | ARCHIVES OF CABINET AFFAIRS DEPARTMENT{% endblock %}

{% block content %}
<div class="container-fluid-custom py-4 px-3">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h1 class="fw-bold text-primary mb-0">ðŸ“„ Documents List</h1>
        <nav class="breadcrumb-nav">
            <a href="{{ url_for('main.admDashboard') }}" class="breadcrumb-link">Dashboard</a> /
            <a href="{{ url_for('main.documentList') }}" class="breadcrumb-link">Documents</a> /
            <span class="breadcrumb-active">Documents List</span>
        </nav>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="alert-messages-container mb-3">
        {% for category, message in messages %}
        <div class="alert-message {{ category }}">
            <span>{{ message }}</span>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="card shadow-sm border-0 rounded-4 p-4 mb-4 bg-white">
        <ul class="nav nav-tabs custom-tabs mb-4 justify-content-center">
            <li class="nav-item">
                <a id="listTab" class="nav-link active" href="javascript:void(0)">
                    <i class="material-icons-outlined align-middle me-1">list</i> List View
                </a>
            </li>
            <li class="nav-item">
                <a id="gridTab" class="nav-link" href="javascript:void(0)">
                    <i class="material-icons-outlined align-middle me-1">grid_view</i> Grid View
                </a>
            </li>
        </ul>

        <form id="filter-form" method="GET" action="javascript:void(0);">
            <div class="row g-3">
                <div class="col-md-4">
                    <select name="category" id="category-filter" class="form-select">
                        <option value="">-- Select Category --</option>
                        {% for cat in distinct_categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <select name="sub_category" id="subcategory-filter" class="form-select">
                        <option value="">-- Select Sub Category --</option>
                        {% for sub_cat in distinct_sub_categories %}
                        <option value="{{ sub_cat }}">{{ sub_cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <select name="tags" id="tags-filter" class="form-select">
                        <option value="">-- Choose Tags --</option>
                        {% for tag in distinct_tags %}
                        <option value="{{ tag }}">{{ tag }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="input-group mt-3">
                <input type="search" name="search" id="search-input" class="form-control"
                       placeholder="Search by keyword in Title, Filename, or Extracted Data...">
                <button type="submit" class="btn btn-primary px-4">Apply Filters</button>
            </div>
        </form>
    </div>

    <div id="listView" class="table-responsive mt-3">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Sub Category</th>
                    <th>Tags</th>
                    <th>File Name</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="document-table-body">
            </tbody>
        </table>
    </div>

    <div id="gridView" class="row g-4 mt-3 d-none">
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="documentViewerModal" tabindex="-1" aria-labelledby="documentViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 rounded-3 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-semibold" id="documentViewerModalLabel">Document Viewer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="documentViewerBody" style="height: 80vh;"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.getElementById('document-table-body');
    const gridView = document.getElementById('gridView');
    const listTab = document.getElementById('listTab');
    const gridTab = document.getElementById('gridTab');
    const listView = document.getElementById('listView');
    const viewerModal = new bootstrap.Modal(document.getElementById('documentViewerModal'));
    const modalBody = document.getElementById('documentViewerBody');
    const modalElement = document.getElementById('documentViewerModal');
    const filterForm = document.getElementById('filter-form');
    const searchInput = document.getElementById('search-input');
    const categoryFilter = document.getElementById('category-filter');
    const subcategoryFilter = document.getElementById('subcategory-filter');
    const tagsFilter = document.getElementById('tags-filter');

    listTab.addEventListener('click', () => {
        listView.classList.remove('d-none');
        gridView.classList.add('d-none');
        listTab.classList.add('active');
        gridTab.classList.remove('active');
    });
    gridTab.addEventListener('click', () => {
        gridView.classList.remove('d-none');
        listView.classList.add('d-none');
        gridTab.classList.add('active');
        listTab.classList.remove('active');
    });

    async function fetchAndRenderDocuments() {
        const params = new URLSearchParams({
            search: searchInput.value,
            category: categoryFilter.value,
            sub_category: subcategoryFilter.value,
            tags: tagsFilter.value
        });
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Loading documents...</td></tr>';
        gridView.innerHTML = '<div class="col-12 text-center py-4">Loading documents...</div>';

        try {
            const response = await fetch(`{{ url_for('main.api_search_documents') }}?${params.toString()}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const documents = await response.json();

            tableBody.innerHTML = '';
            gridView.innerHTML = '';

            if (documents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No documents found.</td></tr>';
                gridView.innerHTML = '<div class="col-12 text-center py-4 text-muted">No documents found.</div>';
                return;
            }

            documents.forEach(doc => {
                const tagsHtml = doc.tags ? doc.tags.split(',').map(tag =>
                    `<span class="badge rounded-pill bg-light text-primary border border-primary">${tag.trim()}</span>`).join(' ') : 'â€”';

                const listRowHtml = `
                    <tr>
                        <td>${doc.created_at || 'N/A'}</td>
                        <td class="text-truncate" title="${doc.title || ''}">${doc.title || ''}</td>
                        <td>${doc.category || 'â€”'}</td>
                        <td>${doc.sub_category || 'â€”'}</td>
                        <td>${tagsHtml}</td>
                        <td class="text-truncate">${doc.original_filename || 'N/A'}</td>
                        <td class="text-center">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary view-doc-btn" 
                                    data-file-url="${doc.file_path}" data-file-title="${doc.title || 'Document'}">
                                    <i class="material-icons-outlined">visibility</i>
                                </button>
                                <a href="/documents/edit/${doc.id}" class="btn btn-sm btn-outline-secondary">
                                    <i class="material-icons-outlined">edit</i>
                                </a>
                                <form action="/documents/delete/${doc.id}" method="POST" class="d-inline" 
                                      onsubmit="return confirm('Are you sure you want to delete this document?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="material-icons-outlined">delete</i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', listRowHtml);

                const gridCardHtml = `
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="card document-card shadow-sm border-0 h-100">
                            <div class="card-body d-flex flex-column align-items-center text-center">
                                <img src="{{ url_for('static', filename='me/PDF_file_icon.svg.png') }}" class="mb-3" style="width:65px;">
                                <h6 class="fw-semibold mb-1 text-truncate" title="${doc.title || ''}">${doc.title || ''}</h6>
                                <small class="text-muted mb-2">${doc.created_at || 'N/A'}</small>
                                <div class="mb-3 small">${tagsHtml}</div>
                                <div class="mt-auto d-flex gap-2">
                                    <button class="btn btn-sm btn-primary view-doc-btn" 
                                            data-file-url="${doc.file_path}" data-file-title="${doc.title || 'Document'}">
                                        View
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">â‹®</button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a href="/documents/edit/${doc.id}" class="dropdown-item">Edit</a></li>
                                            <li><form action="/documents/delete/${doc.id}" method="POST"
                                                      onsubmit="return confirm('Delete this document?');">
                                                <button type="submit" class="dropdown-item text-danger">Delete</button>
                                            </form></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                gridView.insertAdjacentHTML('beforeend', gridCardHtml);
            });

        } catch (err) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Error loading documents.</td></tr>';
            gridView.innerHTML = '<div class="col-12 text-center text-danger py-4">Error loading documents.</div>';
        }
    }

    document.body.addEventListener('click', e => {
        if (e.target.closest('.view-doc-btn')) {
            const btn = e.target.closest('.view-doc-btn');
            const fileUrl = btn.dataset.fileUrl;
            const title = btn.dataset.fileTitle;
            modalBody.innerHTML = `<iframe src="${fileUrl}" class="w-100 h-100 border-0"></iframe>`;
            document.getElementById('documentViewerModalLabel').innerText = title;
            viewerModal.show();
        }
    });
    modalElement.addEventListener('hidden.bs.modal', () => { modalBody.innerHTML = ''; });

    filterForm.addEventListener('submit', e => { e.preventDefault(); fetchAndRenderDocuments(); });
    [categoryFilter, subcategoryFilter, tagsFilter].forEach(el => el.addEventListener('change', fetchAndRenderDocuments));
    fetchAndRenderDocuments();
});
</script>

<style>
/* Professional Styling */
body {
    background-color: #f8f9fc;
}
.container-fluid-custom {
    max-width: 1300px;
    margin: 0 auto;
}
.breadcrumb-nav {
    font-size: 0.9rem;
}
.breadcrumb-link {
    color: #0d6efd;
    text-decoration: none;
}
.breadcrumb-link:hover {
    text-decoration: underline;
}
.breadcrumb-active {
    color: #6c757d;
}
.custom-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-bottom: 3px solid transparent;
    font-weight: 600;
}
.custom-tabs .nav-link.active {
    color: #0d6efd;
    border-bottom-color: #0d6efd;
}
.table th {
    white-space: nowrap;
}
.text-truncate {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.document-card {
    border-radius: 12px;
    transition: all .2s ease-in-out;
}
.document-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.08);
}
.badge {
    font-size: 0.7rem;
    padding: 0.35em 0.6em;
}
.alert-message {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}
.alert-message.success { background-color: #d1e7dd; color: #0f5132; }
.alert-message.error { background-color: #f8d7da; color: #842029; }
.close-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    float: right;
    color: inherit;
}
</style>
{% endblock %}
