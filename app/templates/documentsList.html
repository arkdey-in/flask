{% extends "base.html" %}

{% block title %}Document List | ARCHIVES OF CABINET AFFAIRS DEPARTMENT{% endblock %}

{% block content %}
<div class="container-fluid-custom">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Documents List</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('main.admDashboard') }}">Dashboard</a> &raquo;
            <span>Documents</span>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="alert-messages-container">
        {% for category, message in messages %}
        <div role="alert" class="alert-message {{ category }}">
            <span>{{ message }}</span>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none';" aria-label="Close">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="add-category-form-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">Filters & Search</h5>
            <ul class="nav nav-tabs custom-tabs">
                <li class="nav-item">
                    <a id="listTab" class="nav-link active" href="javascript:void(0)" title="List View">
                        <i class="material-icons-outlined">list</i>
                    </a>
                </li>
                <li class="nav-item">
                    <a id="gridTab" class="nav-link" href="javascript:void(0)" title="Grid View">
                        <i class="material-icons-outlined">grid_view</i>
                    </a>
                </li>
            </ul>
        </div>

        <form id="filter-form" method="GET" action="javascript:void(0);">
            <div class="row gx-2">
                <div class="col-lg-3 col-md-6 mb-2">
                    <select name="category" id="category-filter" class="form-select">
                        <option value="">All Categories</option>
                        {% for cat in distinct_categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <select name="sub_category" id="subcategory-filter" class="form-select">
                        <option value="">All Sub-Categories</option>
                        {% for sub_cat in distinct_sub_categories %}<option value="{{ sub_cat }}">{{ sub_cat }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <select name="tags" id="tags-filter" class="form-select">
                        <option value="">All Tags</option>
                        {% for tag in distinct_tags %}<option value="{{ tag }}">{{ tag }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="input-group">
                        <input type="search" name="search" id="search-input" class="form-control" placeholder="Search...">
                        <button type="submit" class="btn btn-grd-primary" title="Apply Filters">
                            <i class="material-icons-outlined">search</i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="data-container" class="mt-4">
        <div id="listView" class="table-responsive">
            <table class="professional-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Title</th>
                        <th>Category / Sub-Category</th>
                        <th>Tags</th>
                        <th>File Name</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="document-table-body"></tbody>
            </table>
        </div>
        <div id="gridView" class="row d-none"></div>

        <div id="no-documents-placeholder" class="text-center p-5 d-none">
            <div class="no-docs-icon"><i class="material-icons-outlined">find_in_page</i></div>
            <h3>No Documents Found</h3>
            <p class="text-muted">Try adjusting your search filters.</p>
        </div>
    </div>
</div>

<div class="modal fade" id="documentViewerModal" tabindex="-1" aria-labelledby="documentViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="documentViewerModalLabel">Document Viewer</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="documentViewerBody" style="height: 80vh;"></div></div></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tableBody = document.getElementById('document-table-body');
        const gridViewContainer = document.getElementById('gridView');
        const listViewContainer = document.getElementById('listView');
        const noDocsPlaceholder = document.getElementById('no-documents-placeholder');
        const filterForm = document.getElementById('filter-form');
        const listTab = document.getElementById('listTab');
        const gridTab = document.getElementById('gridTab');

        listTab.addEventListener('click', () => { listViewContainer.classList.remove('d-none'); gridViewContainer.classList.add('d-none'); listTab.classList.add('active'); gridTab.classList.remove('active'); });
        gridTab.addEventListener('click', () => { gridViewContainer.classList.remove('d-none'); listViewContainer.classList.add('d-none'); gridTab.classList.add('active'); listTab.classList.remove('active'); });

        async function fetchAndRenderDocuments() {
            const params = new URLSearchParams(new FormData(filterForm));
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
            gridViewContainer.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            noDocsPlaceholder.classList.add('d-none');
            listViewContainer.classList.remove('d-none'); // Show table during load

            try {
                const response = await fetch(`{{ url_for('main.api_search_documents') }}?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const documents = await response.json();

                tableBody.innerHTML = '';
                gridViewContainer.innerHTML = '';

                if (documents.length === 0) {
                    noDocsPlaceholder.classList.remove('d-none');
                    listViewContainer.classList.add('d-none');
                    gridViewContainer.classList.add('d-none');
                } else {
                    noDocsPlaceholder.classList.add('d-none');
                    if (listTab.classList.contains('active')) {
                        listViewContainer.classList.remove('d-none');
                    } else {
                        gridViewContainer.classList.remove('d-none');
                    }
                    
                    documents.forEach(doc => {
                        const createTagsHtml = (tagsString) => {
                            if (!tagsString) return '<span class="text-muted small">No Tags</span>';
                            return `<div class="tags-container">` + tagsString.split(',').map(tag => `<span class="tag-badge">${tag.trim()}</span>`).join('') + `</div>`;
                        };
                        const tagsHtml = createTagsHtml(doc.tags);

                        const listRowHtml = `
                            <tr>
                                <td class="text-nowrap"><small>${doc.created_at || 'N/A'}</small></td>
                                <td><div class="title-truncate" title="${doc.title || ''}">${doc.title || ''}</div></td>
                                <td>${doc.category || ''}<br><small class="text-muted">${doc.sub_category || ''}</small></td>
                                <td>${tagsHtml}</td>
                                <td>
                                    <div class="file-info" title="${doc.original_filename || ''}">
                                        <i class="material-icons-outlined">description</i>
                                        <span>${doc.original_filename || 'N/A'}</span>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <div class="action-buttons">
                                        <button class="btn-action btn-view view-doc-btn" title="View Document" data-file-url="${doc.file_path}" data-file-title="${doc.title || 'Document'}"><i class="material-icons-outlined">visibility</i></button>
                                        <a href="/documents/edit/${doc.id}" class="btn-action btn-edit" title="Edit"><i class="material-icons-outlined">edit</i></a>
                                        <form action="/documents/delete/${doc.id}" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn-action btn-delete" title="Delete"><i class="material-icons-outlined">delete_outline</i></button></form>
                                    </div>
                                </td>
                            </tr>`;
                        tableBody.insertAdjacentHTML('beforeend', listRowHtml);

                        const gridCardHtml = `
                            <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                                <div class="card h-100 shadow-sm border-0 document-card-pro d-flex flex-column">
                                    <div class="card-body flex-grow-1">
                                        <div class="card-img-container"><img src="{{ url_for('static', filename='me/PDF_file_icon.svg.png') }}" alt="PDF" class="card-img-top"><div class="overlay"><i class="material-icons-outlined">visibility</i></div></div>
                                        <h6 class="card-title title-truncate mt-3" title="${doc.title || ''}">${doc.title || ''}</h6>
                                        <p class="text-muted small mb-2">${doc.created_at || 'N/A'}</p>
                                        <div class="mb-3">${tagsHtml}</div>
                                    </div>
                                    <div class="card-footer bg-transparent border-0 pt-0 pb-3">
                                        <div class="action-buttons justify-content-center">
                                            <button class="btn-action btn-view view-doc-btn" title="View Document" data-file-url="${doc.file_path}" data-file-title="${doc.title || 'Document'}"><i class="material-icons-outlined">visibility</i></button>
                                            <a href="/documents/edit/${doc.id}" class="btn-action btn-edit" title="Edit"><i class="material-icons-outlined">edit</i></a>
                                            <form action="/documents/delete/${doc.id}" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure?');"><button type="submit" class="btn-action btn-delete" title="Delete"><i class="material-icons-outlined">delete_outline</i></button></form>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        gridViewContainer.insertAdjacentHTML('beforeend', gridCardHtml);
                    });
                }
            } catch (error) {
                console.error("Failed to fetch documents:", error);
                // Handle error state
            }
        }
        
        filterForm.addEventListener('submit', (e) => { e.preventDefault(); fetchAndRenderDocuments(); });
        filterForm.querySelectorAll('select, input').forEach(el => { el.addEventListener('change', fetchAndRenderDocuments); });
        
        fetchAndRenderDocuments();
        
        // Modal logic
        const viewerModal = new bootstrap.Modal(document.getElementById('documentViewerModal'));
        const modalTitle = document.getElementById('documentViewerModalLabel');
        const modalBody = document.getElementById('documentViewerBody');
        document.body.addEventListener('click', function(event) {
            const viewBtn = event.target.closest('.view-doc-btn');
            if (viewBtn) {
                 const fileUrl = viewBtn.dataset.fileUrl;
                const fileTitle = viewBtn.dataset.fileTitle;
                modalTitle.textContent = fileTitle;
                if (fileUrl && fileUrl.split('.').pop().toLowerCase() === 'pdf') {
                    modalBody.innerHTML = `<iframe src="${fileUrl}" style="width: 100%; height: 100%; border: none;"></iframe>`;
                } else if (fileUrl) {
                    modalBody.innerHTML = `<img src="${fileUrl}" style="width: 100%; height: 100%; object-fit: contain;" alt="${fileTitle}">`;
                } else {
                    modalBody.innerHTML = `<div class="text-center p-5"><p>File not available for preview.</p></div>`;
                }
                viewerModal.show();
            }
        });
    });
</script>

<style>
    /* Professional Styling Overhaul */
    :root { --acad-border-color: #dee2e6; --acad-light-bg: #f8f9fa; }
    
    /* Tabs */
    .custom-tabs { border-bottom: none; }
    .custom-tabs .nav-link { font-weight: 500; border: none; border-bottom: 3px solid transparent; transition: all .2s ease; padding: .5rem .75rem; }
    .custom-tabs .nav-link.active { color: var(--bs-primary); border-bottom-color: var(--bs-primary); background: transparent; }
    .custom-tabs .nav-link i { vertical-align: middle; }

    /* Table List View */
    .professional-table { width: 100%; border-collapse: collapse; }
    .professional-table thead { border-bottom: 2px solid var(--acad-border-color); }
    .professional-table th { color: #6c757d; font-weight: 600; text-transform: uppercase; font-size: .75rem; padding: .75rem 1rem; letter-spacing: .5px; }
    .professional-table tbody tr { border-bottom: 1px solid var(--acad-border-color); transition: background-color .2s ease; }
    .professional-table tbody tr:last-child { border-bottom: none; }
    .professional-table tbody tr:hover { background-color: var(--acad-light-bg); }
    .professional-table td { padding: 1rem; vertical-align: middle !important; }

    .file-info { display: flex; align-items: center; gap: .5rem; color: #495057; }
    .file-info i { color: #6c757d; }
    .file-info span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

    /* Grid View Card */
    .document-card-pro { border-radius: .75rem; transition: transform .2s ease, box-shadow .2s ease; }
    .document-card-pro:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.1)!important; }
    .card-img-container { position: relative; overflow: hidden; border-radius: .5rem; background: #f1f3f5; }
    .card-img-container .card-img-top { padding: 1rem; }
    .card-img-container .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity .3s ease; }
    .document-card-pro:hover .overlay { opacity: 1; }
    
    /* Shared Elements */
    .tags-container { display: flex; flex-wrap: wrap; gap: 5px; justify-content: flex-start; }
    .document-card-pro .tags-container { justify-content: center; }
    .tag-badge { background-color: #e7f3ff; color: #0d6efd; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
    .title-truncate { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
    
    .action-buttons { display: flex; gap: .25rem; justify-content: flex-end; }
    .btn-action { background: none; border: 1px solid transparent; padding: 0; color: #6c757d; border-radius: 50%; width: 34px; height: 34px; display: inline-flex; align-items: center; justify-content: center; transition: all .2s ease; }
    .btn-action i { font-size: 1.2rem; }
    .btn-action:hover { color: var(--bs-primary); background-color: #e7f3ff; }
    .btn-action.btn-delete:hover { color: var(--bs-danger); background-color: #f8d7da; }

    /* No Documents Placeholder */
    #no-documents-placeholder { border: 2px dashed var(--acad-border-color); border-radius: 1rem; background-color: var(--acad-light-bg); }
    .no-docs-icon i { font-size: 4rem; color: #ced4da; }

    /* Responsive Table */
    @media (max-width: 991px) {
        .table-responsive { overflow-x: auto; }
        .professional-table { min-width: 800px; } /* Force a minimum width */
    }
</style>
{% endblock %}